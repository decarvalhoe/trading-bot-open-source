<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trading Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <header class="layout__header">
      <h1 class="heading heading--xl">Vue d'ensemble des portefeuilles</h1>
      <p class="text text--muted">
        Surveillez les portefeuilles, transactions récentes et alertes critiques en un coup d'œil.
      </p>
    </header>
    <main class="layout__main">
      {% if context.metrics %}
      <section class="card card--metrics" aria-labelledby="metrics-title">
        <div class="card__header">
          <h2 id="metrics-title" class="heading heading--lg">Performance</h2>
          <p class="text text--muted">
            {% if context.metrics.account %}
            Compte {{ context.metrics.account }}
            {% endif %}
            {% if context.metrics.as_of %}
            · Mise à jour le {{ context.metrics.as_of.strftime('%d/%m/%Y') }}
            {% endif %}
          </p>
        </div>
        <div class="card__body">
          {% if context.metrics.available %}
          <div class="metrics-grid" role="list" aria-describedby="metrics-title">
            {% set pnl_positive = context.metrics.current_pnl >= 0 %}
            <article class="metric-card" role="listitem" aria-labelledby="metric-pnl-label">
              <p id="metric-pnl-label" class="metric-card__label">P&amp;L courant</p>
              <p
                class="metric-card__value {{ 'metric-card__value--positive' if pnl_positive else 'metric-card__value--negative' }}"
              >
                {{ '%.2f' | format(context.metrics.current_pnl) }} {{ context.metrics.currency }}
              </p>
              <span
                class="badge {{ 'badge--success' if pnl_positive else 'badge--critical' }}"
                aria-label="{{ 'Gain' if pnl_positive else 'Perte' }} sur la dernière session"
                >{{ 'Gain' if pnl_positive else 'Perte' }}</span
              >
            </article>

            <article class="metric-card" role="listitem" aria-labelledby="metric-dd-label">
              <p id="metric-dd-label" class="metric-card__label">Drawdown</p>
              <p class="metric-card__value metric-card__value--negative">
                {{ '%.2f' | format(context.metrics.current_drawdown) }} {{ context.metrics.currency }}
              </p>
              <span class="badge badge--warning" aria-label="Drawdown cumulé">
                Protection du capital
              </span>
            </article>

            {% set cumulative_positive = context.metrics.cumulative_return >= 0 %}
            <article class="metric-card" role="listitem" aria-labelledby="metric-return-label">
              <p id="metric-return-label" class="metric-card__label">Rendement cumulatif</p>
              <p
                class="metric-card__value {{ 'metric-card__value--positive' if cumulative_positive else 'metric-card__value--negative' }}"
              >
                {% if context.metrics.cumulative_return_is_ratio %}
                {{ '%.2f' | format(context.metrics.cumulative_return * 100) }} %
                {% else %}
                {{ '%.2f' | format(context.metrics.cumulative_return) }} {{ context.metrics.currency }}
                {% endif %}
              </p>
              <span
                class="badge {{ 'badge--success' if cumulative_positive else 'badge--critical' }}"
                aria-label="Rendement composé basé sur les sessions disponibles"
                >{{ 'En hausse' if cumulative_positive else 'En baisse' }}</span
              >
            </article>

            <article class="metric-card" role="listitem" aria-labelledby="metric-sharpe-label">
              <p id="metric-sharpe-label" class="metric-card__label">Sharpe annualisé</p>
              <p class="metric-card__value">
                {% if context.metrics.sharpe_ratio is not none %}
                {{ '%.2f' | format(context.metrics.sharpe_ratio) }}
                {% else %}
                —
                {% endif %}
              </p>
              {% if context.metrics.sharpe_ratio is not none %}
              {% set sharpe = context.metrics.sharpe_ratio %}
              {% set sharpe_badge = 'badge--critical' %}
              {% set sharpe_label = 'Sous la cible' %}
              {% if sharpe >= 1.5 %}
              {% set sharpe_badge = 'badge--success' %}
              {% set sharpe_label = 'Excellent' %}
              {% elif sharpe >= 1.0 %}
              {% set sharpe_badge = 'badge--info' %}
              {% set sharpe_label = 'Solide' %}
              {% elif sharpe >= 0 %}
              {% set sharpe_badge = 'badge--warning' %}
              {% set sharpe_label = 'À surveiller' %}
              {% endif %}
              <span class="badge {{ sharpe_badge }}" aria-label="{{ sharpe_label }}">{{ sharpe_label }}</span>
              {% else %}
              <span class="badge badge--neutral" aria-label="Sharpe non disponible">ND</span>
              {% endif %}
            </article>
          </div>
          <p class="text text--muted metrics__footnote">
            {% if context.metrics.sample_size %}
            Basé sur {{ context.metrics.sample_size }} session{{ 's' if context.metrics.sample_size > 1 else '' }}
            {% else %}
            Données insuffisantes pour calculer toutes les métriques.
            {% endif %}
            {% if context.metrics.uses_exposure %}
            Normalisation par l'exposition quotidienne active.
            {% endif %}
          </p>
          {% else %}
          <p class="text text--muted">
            Les métriques de performance ne sont pas disponibles pour le moment. Vérifiez la connexion avec
            reports-service.
          </p>
          {% endif %}
          <div class="chart-panel" aria-label="Historique de performance des portefeuilles">
            <div class="chart-panel__header">
              <h3 class="heading heading--md">Historique de performance</h3>
              <p class="text text--muted">Évolution quotidienne de la valeur totale par portefeuille.</p>
            </div>
            <div
              id="portfolio-chart"
              class="chart-container"
              data-endpoint="/portfolios/history"
              data-currency="{{ context.metrics.currency if context.metrics else '$' }}"
              role="img"
              aria-label="Graphique des valeurs cumulées des portefeuilles"
            ></div>
          </div>
        </div>
      </section>
      {% endif %}

      <section class="card" aria-labelledby="portfolios-title">
        <div class="card__header">
          <h2 id="portfolios-title" class="heading heading--lg">Portefeuilles</h2>
        </div>
        <div class="card__body">
          <ul class="portfolio-list">
            {% for portfolio in context.portfolios %}
            <li class="portfolio-list__item">
              <div class="portfolio-list__title">
                <span class="badge badge--neutral" aria-label="Nom du portefeuille">{{ portfolio.name }}</span>
                <span class="text text--muted">Géré par {{ portfolio.owner }}</span>
              </div>
              <div class="portfolio-list__value" aria-label="Valeur totale">
                {{ '%.2f' | format(portfolio.total_value) }} $
              </div>
              <table class="table" role="grid" aria-label="Positions du portefeuille {{ portfolio.name }}">
                <thead>
                  <tr>
                    <th scope="col">Symbole</th>
                    <th scope="col">Quantité</th>
                    <th scope="col">Px. moyen</th>
                    <th scope="col">Px. actuel</th>
                    <th scope="col">Valeur</th>
                  </tr>
                </thead>
                <tbody>
                  {% for holding in portfolio.holdings %}
                  <tr>
                    <td data-label="Symbole">{{ holding.symbol }}</td>
                    <td data-label="Quantité">{{ '%.2f' | format(holding.quantity) }}</td>
                    <td data-label="Prix moyen">{{ '%.2f' | format(holding.average_price) }} $</td>
                    <td data-label="Prix actuel">{{ '%.2f' | format(holding.current_price) }} $</td>
                    <td data-label="Valeur">{{ '%.2f' | format(holding.market_value) }} $</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </li>
            {% endfor %}
          </ul>
        </div>
      </section>

      <section class="card" aria-labelledby="transactions-title">
        <div class="card__header">
          <h2 id="transactions-title" class="heading heading--lg">Transactions récentes</h2>
        </div>
        <div class="card__body">
          <table class="table" role="grid" aria-describedby="transactions-title">
            <thead>
              <tr>
                <th scope="col">Horodatage</th>
                <th scope="col">Portefeuille</th>
                <th scope="col">Symbole</th>
                <th scope="col">Sens</th>
                <th scope="col">Quantité</th>
                <th scope="col">Prix</th>
              </tr>
            </thead>
            <tbody>
              {% for tx in context.transactions %}
              <tr>
                <td data-label="Horodatage">{{ tx.timestamp.strftime('%d/%m %H:%M') }}</td>
                <td data-label="Portefeuille">{{ tx.portfolio }}</td>
                <td data-label="Symbole">{{ tx.symbol }}</td>
                <td data-label="Sens">
                  <span class="badge badge--{{ 'success' if tx.side == 'buy' else 'warning' }}">{{ tx.side|capitalize }}</span>
                </td>
                <td data-label="Quantité">{{ '%.2f' | format(tx.quantity) }}</td>
                <td data-label="Prix">{{ '%.2f' | format(tx.price) }} $</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <section class="card" aria-labelledby="alerts-title">
        <div class="card__header">
          <h2 id="alerts-title" class="heading heading--lg">Alertes</h2>
        </div>
        <div class="card__body">
          <ul class="alert-list">
            {% for alert in context.alerts %}
            <li class="alert-list__item">
              <div class="alert-list__status">
                <span class="badge badge--{{ 'critical' if alert.risk.value == 'critical' else 'warning' if alert.risk.value == 'warning' else 'info' }}">
                  {{ alert.risk.value | capitalize }}
                </span>
              </div>
              <div class="alert-list__content">
                <h3 class="heading heading--md">{{ alert.title }}</h3>
                <p class="text">{{ alert.detail }}</p>
                <p class="text text--muted">
                  Créée {{ alert.created_at.strftime('%d/%m %H:%M') }} ·
                  {% if alert.acknowledged %}
                  <span class="badge badge--neutral" aria-label="Alerte confirmée">Accusée</span>
                  {% else %}
                  <span class="badge badge--info" aria-label="Alerte non confirmée">À traiter</span>
                  {% endif %}
                </p>
              </div>
            </li>
            {% endfor %}
          </ul>
        </div>
      </section>
    </main>
    <footer class="layout__footer">
      <p class="text text--muted">Données d'exemple pour la démonstration du service.</p>
    </footer>
    <script id="dashboard-bootstrap" type="application/json">
      {{ {"context": context.model_dump(mode='json'), "streaming": streaming}|tojson }}
    </script>
    <script src="/static/dashboard.js" defer></script>
    <script type="module" src="/static/dist/portfolio-chart.js"></script>
  </body>
</html>
