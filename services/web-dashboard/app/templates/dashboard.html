<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trading Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <header class="layout__header">
      <nav class="app-nav" aria-label="Navigation principale">
        <a
          href="{{ request.url_for('render_dashboard') }}"
          class="app-nav__link {{ 'app-nav__link--active' if active_page == 'dashboard' else '' }}"
          aria-current="{{ 'page' if active_page == 'dashboard' else 'false' }}"
        >
          Tableau de bord
        </a>
        <a
          href="{{ request.url_for('render_strategies') }}"
          class="app-nav__link {{ 'app-nav__link--active' if active_page == 'strategies' else '' }}"
          aria-current="{{ 'page' if active_page == 'strategies' else 'false' }}"
        >
          Stratégies
        </a>
        <a
          href="{{ request.url_for('render_strategy_documentation') }}"
          class="app-nav__link {{ 'app-nav__link--active' if active_page == 'strategy-docs' else '' }}"
          aria-current="{{ 'page' if active_page == 'strategy-docs' else 'false' }}"
        >
          Documentation stratégies
        </a>
        <a
          href="{{ request.url_for('render_account') }}"
          class="app-nav__link {{ 'app-nav__link--active' if active_page == 'account' else '' }}"
          aria-current="{{ 'page' if active_page == 'account' else 'false' }}"
        >
          Compte &amp; API
        </a>
      </nav>
      <h1 class="heading heading--xl">Vue d'ensemble des portefeuilles</h1>
      <p class="text text--muted">
        Surveillez les portefeuilles, transactions récentes et alertes critiques en un coup d'œil.
      </p>
    </header>
    <main class="layout__main">
      {% if context.metrics %}
      <section class="card card--metrics" aria-labelledby="metrics-title">
        <div class="card__header">
          <h2 id="metrics-title" class="heading heading--lg">Performance</h2>
          <p class="text text--muted">
            {% if context.metrics.account %}
            Compte {{ context.metrics.account }}
            {% endif %}
            {% if context.metrics.as_of %}
            · Mise à jour le {{ context.metrics.as_of.strftime('%d/%m/%Y') }}
            {% endif %}
          </p>
        </div>
        <div class="card__body">
          {% if context.metrics.available %}
          <div class="metrics-grid" role="list" aria-describedby="metrics-title">
            {% set pnl_positive = context.metrics.current_pnl >= 0 %}
            <article class="metric-card" role="listitem" aria-labelledby="metric-pnl-label">
              <p id="metric-pnl-label" class="metric-card__label">P&amp;L courant</p>
              <p
                class="metric-card__value {{ 'metric-card__value--positive' if pnl_positive else 'metric-card__value--negative' }}"
              >
                {{ '%.2f' | format(context.metrics.current_pnl) }} {{ context.metrics.currency }}
              </p>
              <span
                class="badge {{ 'badge--success' if pnl_positive else 'badge--critical' }}"
                aria-label="{{ 'Gain' if pnl_positive else 'Perte' }} sur la dernière session"
                >{{ 'Gain' if pnl_positive else 'Perte' }}</span
              >
            </article>

            <article class="metric-card" role="listitem" aria-labelledby="metric-dd-label">
              <p id="metric-dd-label" class="metric-card__label">Drawdown</p>
              <p class="metric-card__value metric-card__value--negative">
                {{ '%.2f' | format(context.metrics.current_drawdown) }} {{ context.metrics.currency }}
              </p>
              <span class="badge badge--warning" aria-label="Drawdown cumulé">
                Protection du capital
              </span>
            </article>

            {% set cumulative_positive = context.metrics.cumulative_return >= 0 %}
            <article class="metric-card" role="listitem" aria-labelledby="metric-return-label">
              <p id="metric-return-label" class="metric-card__label">Rendement cumulatif</p>
              <p
                class="metric-card__value {{ 'metric-card__value--positive' if cumulative_positive else 'metric-card__value--negative' }}"
              >
                {% if context.metrics.cumulative_return_is_ratio %}
                {{ '%.2f' | format(context.metrics.cumulative_return * 100) }} %
                {% else %}
                {{ '%.2f' | format(context.metrics.cumulative_return) }} {{ context.metrics.currency }}
                {% endif %}
              </p>
              <span
                class="badge {{ 'badge--success' if cumulative_positive else 'badge--critical' }}"
                aria-label="Rendement composé basé sur les sessions disponibles"
                >{{ 'En hausse' if cumulative_positive else 'En baisse' }}</span
              >
            </article>

            <article class="metric-card" role="listitem" aria-labelledby="metric-sharpe-label">
              <p id="metric-sharpe-label" class="metric-card__label">Sharpe annualisé</p>
              <p class="metric-card__value">
                {% if context.metrics.sharpe_ratio is not none %}
                {{ '%.2f' | format(context.metrics.sharpe_ratio) }}
                {% else %}
                —
                {% endif %}
              </p>
              {% if context.metrics.sharpe_ratio is not none %}
              {% set sharpe = context.metrics.sharpe_ratio %}
              {% set sharpe_badge = 'badge--critical' %}
              {% set sharpe_label = 'Sous la cible' %}
              {% if sharpe >= 1.5 %}
              {% set sharpe_badge = 'badge--success' %}
              {% set sharpe_label = 'Excellent' %}
              {% elif sharpe >= 1.0 %}
              {% set sharpe_badge = 'badge--info' %}
              {% set sharpe_label = 'Solide' %}
              {% elif sharpe >= 0 %}
              {% set sharpe_badge = 'badge--warning' %}
              {% set sharpe_label = 'À surveiller' %}
              {% endif %}
              <span class="badge {{ sharpe_badge }}" aria-label="{{ sharpe_label }}">{{ sharpe_label }}</span>
              {% else %}
              <span class="badge badge--neutral" aria-label="Sharpe non disponible">ND</span>
              {% endif %}
            </article>
          </div>
          <p class="text text--muted metrics__footnote">
            {% if context.metrics.sample_size %}
            Basé sur {{ context.metrics.sample_size }} session{{ 's' if context.metrics.sample_size > 1 else '' }}
            {% else %}
            Données insuffisantes pour calculer toutes les métriques.
            {% endif %}
            {% if context.metrics.uses_exposure %}
            Normalisation par l'exposition quotidienne active.
            {% endif %}
          </p>
          {% else %}
          <p class="text text--muted">
            Les métriques de performance ne sont pas disponibles pour le moment. Vérifiez la connexion avec
            reports-service.
          </p>
          {% endif %}
          <div class="chart-panel" aria-label="Historique de performance des portefeuilles">
            <div class="chart-panel__header">
              <h3 class="heading heading--md">Historique de performance</h3>
              <p class="text text--muted">Évolution quotidienne de la valeur totale par portefeuille.</p>
            </div>
            <div
              id="portfolio-chart"
              class="chart-container"
              data-endpoint="/portfolios/history"
              data-currency="{{ context.metrics.currency if context.metrics else '$' }}"
              role="img"
              aria-label="Graphique des valeurs cumulées des portefeuilles"
            ></div>
          </div>
        </div>
      </section>
      {% endif %}

      <section class="card" aria-labelledby="reports-title">
        <div class="card__header">
          <h2 id="reports-title" class="heading heading--lg">Rapports</h2>
          <p class="text text--muted">Exports générés par le service de rapports.</p>
        </div>
        <div class="card__body">
          <div
            id="reports-center"
            class="reports-center"
            data-page-size="5"
            data-reports='{{ context.model_dump(mode="json")["reports"] | tojson }}'
            aria-live="polite"
          >
            <noscript>
              {% if context.reports %}
              <ul class="reports-list" role="list">
                {% for report in context.reports %}
                <li class="reports-list__item" role="listitem">
                  <div class="reports-list__meta">
                    <span class="reports-list__title heading heading--md">{{ report.report_type }}</span>
                    <p class="reports-list__period text text--muted">
                      {% if report.period %}Période : {{ report.period }}{% else %}Période non précisée{% endif %}
                      {% if report.generated_at %} · Généré le {{ report.generated_at.strftime('%d/%m/%Y') }}{% endif %}
                    </p>
                    {% if report.status %}
                    <span class="badge badge--info reports-list__status">{{ report.status|capitalize }}</span>
                    {% endif %}
                  </div>
                  <div class="reports-list__actions">
                    {% if report.download_url %}
                    <a class="button button--ghost" href="{{ report.download_url }}">Télécharger</a>
                    {% else %}
                    <span class="text text--muted">Téléchargement indisponible</span>
                    {% endif %}
                  </div>
                </li>
                {% endfor %}
              </ul>
              {% else %}
              <p class="text text--muted">Aucun rapport disponible pour le moment.</p>
              {% endif %}
            </noscript>
          </div>
        </div>
      </section>

      <section class="card card--setups" aria-labelledby="inplay-setups-title">
        <div class="card__header card__header--inline">
          <div class="card__header-content">
            <h2 id="inplay-setups-title" class="heading heading--lg">Setups en temps réel</h2>
            <p class="text text--muted">Propulsé par le flux InPlay</p>
          </div>
          <label class="log-filter session-filter" for="session-filter">
            <span class="text text--muted">Session</span>
            <select id="session-filter" class="select">
              <option value="all" selected>Toutes les sessions</option>
              <option value="london">Londres</option>
              <option value="new_york">New York</option>
              <option value="asia">Asie</option>
            </select>
          </label>
        </div>
        <div class="card__body">
          <p
            id="inplay-setups-status"
            class="inplay-setups__status text text--muted"
            role="status"
            aria-live="polite"
          >
            {% if context.setups and context.setups.fallback_reason %}
            {{ context.setups.fallback_reason }}
            {% else %}
            Flux InPlay connecté.
            {% endif %}
          </p>
          <div class="inplay-setups__grid" role="list" aria-describedby="inplay-setups-title">
            {% if context.setups and context.setups.watchlists %}
            {% for watchlist in context.setups.watchlists %}
            {% for symbol in watchlist.symbols %}
            {% for setup in symbol.setups %}
            <article class="setup-card" role="listitem">
              <div class="setup-card__header">
                <span class="setup-card__strategy heading heading--md">{{ setup.strategy }}</span>
                {% set status = setup.status.value if setup.status else setup.status %}
                {% set status_class = 'badge--info' %}
                {% if status == 'validated' %}
                {% set status_class = 'badge--success' %}
                {% elif status == 'failed' %}
                {% set status_class = 'badge--critical' %}
                {% elif status and status != 'pending' %}
                {% set status_class = 'badge--warning' %}
                {% endif %}
                <span class="badge {{ status_class }}">{{ status.capitalize() if status else 'Pending' }}</span>
              </div>
              <p class="setup-card__meta text text--muted">
                {{ symbol.symbol }}
                {% if watchlist.id %}· Watchlist {{ watchlist.id }}{% endif %}
                {% if setup.updated_at %}· Maj {{ setup.updated_at.strftime('%d/%m %H:%M') }}{% endif %}
              </p>
              <dl class="setup-card__metrics">
                <dt class="setup-card__metric-label">Entrée</dt>
                <dd class="setup-card__metric-value">
                  {% if setup.entry is not none %}{{ '%.2f' | format(setup.entry) }}{% else %}—{% endif %}
                </dd>
                <dt class="setup-card__metric-label">Cible</dt>
                <dd class="setup-card__metric-value">
                  {% if setup.target is not none %}{{ '%.2f' | format(setup.target) }}{% else %}—{% endif %}
                </dd>
                <dt class="setup-card__metric-label">Stop</dt>
                <dd class="setup-card__metric-value">
                  {% if setup.stop is not none %}{{ '%.2f' | format(setup.stop) }}{% else %}—{% endif %}
                </dd>
                <dt class="setup-card__metric-label">Probabilité</dt>
                <dd class="setup-card__metric-value">
                  {% if setup.probability is not none %}
                  {% if setup.probability <= 1 %}
                  {{ '%.0f' | format(setup.probability * 100) }} %
                  {% else %}
                  {{ '%.0f' | format(setup.probability) }} %
                  {% endif %}
                  {% else %}
                  —
                  {% endif %}
                </dd>
              </dl>
              {% if setup.report_url %}
              <div class="setup-card__actions">
                <a
                  class="button button--secondary"
                  href="{{ setup.report_url }}"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  Voir le rapport
                </a>
              </div>
              {% endif %}
            </article>
            {% endfor %}
            {% endfor %}
            {% endfor %}
            {% else %}
            <p class="text text--muted inplay-setups__empty">
              Aucun setup en temps réel n'est disponible pour le moment.
            </p>
            {% endif %}
          </div>
          <noscript>
            <p class="text text--muted">
              Activez JavaScript pour suivre les mises à jour en direct du flux InPlay.
            </p>
          </noscript>
        </div>
      </section>

      <section class="card card--strategies" aria-labelledby="strategies-title">
        <div class="card__header card__header--inline">
          <h2 id="strategies-title" class="heading heading--lg">Stratégies</h2>
          <p class="text text--muted">Synchronisées avec l'orchestrateur</p>
        </div>
        <div class="card__body">
          <table class="table strategy-table" role="grid" aria-describedby="strategies-title">
            <thead>
              <tr>
                <th scope="col">Nom</th>
                <th scope="col">Statut</th>
                <th scope="col">Dernière exécution</th>
                <th scope="col">Détails</th>
                <th scope="col">Erreur récente</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody
              class="strategy-table__body"
              data-clone-endpoint="{{ request.url_for('clone_strategy_action') }}"
            >
              {% if context.strategies %}
              {% for strategy in context.strategies %}
              <tr>
                <td data-label="Nom">
                  <div class="strategy-name">
                    <span class="heading heading--md">{{ strategy.name }}</span>
                    {% if strategy.strategy_type %}
                    <span class="badge badge--neutral">{{ strategy.strategy_type }}</span>
                    {% endif %}
                    {% if strategy.derived_from_name or strategy.derived_from %}
                    <p class="text text--muted strategy-name__parent">
                      Clone de {{ strategy.derived_from_name or strategy.derived_from }}
                    </p>
                    {% endif %}
                  </div>
                </td>
                <td data-label="Statut">
                  {% set status = strategy.status.value if strategy.status else strategy.status %}
                  {% set status_lower = status.lower() if status else 'pending' %}
                  {% set status_badge = 'badge--warning' %}
                  {% if status == 'ACTIVE' %}
                  {% set status_badge = 'badge--success' %}
                  {% elif status == 'ERROR' %}
                  {% set status_badge = 'badge--critical' %}
                  {% elif status == 'PENDING' %}
                  {% set status_badge = 'badge--info' %}
                  {% endif %}
                  <span class="badge {{ status_badge }}">{{ status }}</span>
                </td>
                <td data-label="Dernière exécution">
                  {% if strategy.last_execution and strategy.last_execution.submitted_at %}
                  {{ strategy.last_execution.submitted_at.strftime('%d/%m %H:%M') }}
                  {% else %}
                  <span class="text text--muted">Aucune</span>
                  {% endif %}
                </td>
                <td data-label="Détails">
                  {% if strategy.last_execution %}
                  <p class="text text--muted">
                    {% if strategy.last_execution.status %}
                    {{ strategy.last_execution.status }}
                    {% endif %}
                    {% if strategy.last_execution.symbol %}
                    · {{ strategy.last_execution.symbol }}
                    {% endif %}
                    {% if strategy.last_execution.order_id %}
                    · Ordre {{ strategy.last_execution.order_id }}
                    {% endif %}
                  </p>
                  {% else %}
                  <span class="text text--muted">En attente d'exécution</span>
                  {% endif %}
                </td>
                <td data-label="Erreur récente">
                  {% if strategy.last_error %}
                  <p class="text text--critical">{{ strategy.last_error }}</p>
                  {% else %}
                  <span class="text text--muted">—</span>
                  {% endif %}
                </td>
                <td data-label="Actions">
                  <form
                    method="post"
                    action="{{ request.url_for('clone_strategy_action') }}"
                    class="strategy-actions__form"
                  >
                    <input type="hidden" name="strategy_id" value="{{ strategy.id }}" />
                    <button type="submit" class="button button--ghost button--small">
                      Cloner
                    </button>
                  </form>
                </td>
              </tr>
              {% endfor %}
              {% else %}
              <tr>
                <td colspan="6">
                  <p class="text text--muted">Aucune stratégie enregistrée pour le moment.</p>
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </section>

      <section class="card card--logs" aria-labelledby="logs-title">
        <div class="card__header card__header--inline">
          <h2 id="logs-title" class="heading heading--lg">Activité en direct</h2>
          <label class="log-filter" for="log-filter">
            <span class="text text--muted">Filtrer par stratégie</span>
            <select id="log-filter" class="select">
              <option value="all" selected>Toutes les stratégies</option>
              {% for strategy in context.strategies %}
              <option value="{{ strategy.id }}">{{ strategy.name }}</option>
              {% endfor %}
            </select>
          </label>
        </div>
        <div class="card__body">
          <div class="log-console" role="log" aria-live="polite">
            <ul id="log-entries" class="log-console__list">
              {% if context.logs %}
              {% for entry in context.logs %}
              <li class="log-console__item" data-strategy="{{ entry.strategy_id or '' }}">
                <div class="log-console__meta">
                  <time datetime="{{ entry.timestamp.isoformat() }}">
                    {{ entry.timestamp.strftime('%d/%m %H:%M:%S') }}
                  </time>
                  {% if entry.status %}
                  <span class="badge badge--neutral">{{ entry.status }}</span>
                  {% endif %}
                  {% if entry.symbol %}
                  <span class="badge badge--info">{{ entry.symbol }}</span>
                  {% endif %}
                </div>
                <p class="log-console__message">{{ entry.message }}</p>
              </li>
              {% endfor %}
              {% else %}
              <li class="log-console__item log-console__item--empty">
                <p class="text text--muted">En attente d'événements. Les exécutions apparaîtront ici en temps réel.</p>
              </li>
              {% endif %}
            </ul>
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="portfolios-title">
        <div class="card__header">
          <h2 id="portfolios-title" class="heading heading--lg">Portefeuilles</h2>
        </div>
        <div class="card__body">
          <ul class="portfolio-list">
            {% for portfolio in context.portfolios %}
            <li class="portfolio-list__item">
              <div class="portfolio-list__title">
                <span class="badge badge--neutral" aria-label="Nom du portefeuille">{{ portfolio.name }}</span>
                <span class="text text--muted">Géré par {{ portfolio.owner }}</span>
              </div>
              <div class="portfolio-list__value" aria-label="Valeur totale">
                {{ '%.2f' | format(portfolio.total_value) }} $
              </div>
              <table class="table" role="grid" aria-label="Positions du portefeuille {{ portfolio.name }}">
                <thead>
                  <tr>
                    <th scope="col">Symbole</th>
                    <th scope="col">Quantité</th>
                    <th scope="col">Px. moyen</th>
                    <th scope="col">Px. actuel</th>
                    <th scope="col">Valeur</th>
                    <th scope="col">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for holding in portfolio.holdings %}
                  <tr>
                    <td data-label="Symbole">{{ holding.symbol }}</td>
                    <td data-label="Quantité">{{ '%.2f' | format(holding.quantity) }}</td>
                    <td data-label="Prix moyen">{{ '%.2f' | format(holding.average_price) }} $</td>
                    <td data-label="Prix actuel">{{ '%.2f' | format(holding.current_price) }} $</td>
                    <td data-label="Valeur">{{ '%.2f' | format(holding.market_value) }} $</td>
                    <td data-label="Actions">
                      <div class="portfolio-actions">
                        <button
                          type="button"
                          class="button button--ghost portfolio-actions__button"
                          data-action="close"
                          data-position-id="{{ (holding.id or (holding.portfolio or portfolio.owner) ~ ':' ~ holding.symbol)|e }}"
                          data-portfolio="{{ (holding.portfolio or portfolio.owner)|e }}"
                          data-quantity="{{ holding.quantity }}"
                          data-symbol="{{ holding.symbol|e }}"
                        >
                          Fermer
                        </button>
                        <button
                          type="button"
                          class="button button--ghost portfolio-actions__button"
                          data-action="adjust"
                          data-position-id="{{ (holding.id or (holding.portfolio or portfolio.owner) ~ ':' ~ holding.symbol)|e }}"
                          data-portfolio="{{ (holding.portfolio or portfolio.owner)|e }}"
                          data-quantity="{{ holding.quantity }}"
                          data-symbol="{{ holding.symbol|e }}"
                        >
                          Ajuster
                        </button>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </li>
            {% endfor %}
          </ul>
        </div>
      </section>

      <section class="card" aria-labelledby="transactions-title">
        <div class="card__header">
          <h2 id="transactions-title" class="heading heading--lg">Transactions récentes</h2>
        </div>
        <div class="card__body">
          <table class="table" role="grid" aria-describedby="transactions-title">
            <thead>
              <tr>
                <th scope="col">Horodatage</th>
                <th scope="col">Portefeuille</th>
                <th scope="col">Symbole</th>
                <th scope="col">Sens</th>
                <th scope="col">Quantité</th>
                <th scope="col">Prix</th>
              </tr>
            </thead>
            <tbody>
              {% for tx in context.transactions %}
              <tr>
                <td data-label="Horodatage">{{ tx.timestamp.strftime('%d/%m %H:%M') }}</td>
                <td data-label="Portefeuille">{{ tx.portfolio }}</td>
                <td data-label="Symbole">{{ tx.symbol }}</td>
                <td data-label="Sens">
                  <span class="badge badge--{{ 'success' if tx.side == 'buy' else 'warning' }}">{{ tx.side|capitalize }}</span>
                </td>
                <td data-label="Quantité">{{ '%.2f' | format(tx.quantity) }}</td>
                <td data-label="Prix">{{ '%.2f' | format(tx.price) }} $</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <section class="card" aria-labelledby="alerts-title">
        <div class="card__header">
          <h2 id="alerts-title" class="heading heading--lg">Alertes</h2>
        </div>
        <div class="card__body">
          <div
            id="alerts-manager"
            data-alerts-react-root="true"
            data-endpoint="{{ alerts_api.endpoint }}"
            data-auth-token="{{ alerts_api.token }}"
          >
            <noscript>
              <ul class="alert-list">
                {% for alert in context.alerts %}
                <li class="alert-list__item">
                  <div class="alert-list__status">
                    <span class="badge badge--{{ 'critical' if alert.risk.value == 'critical' else 'warning' if alert.risk.value == 'warning' else 'info' }}">
                      {{ alert.risk.value | capitalize }}
                    </span>
                  </div>
                  <div class="alert-list__content">
                    <h3 class="heading heading--md">{{ alert.title }}</h3>
                    <p class="text">{{ alert.detail }}</p>
                    <p class="text text--muted">
                      Créée {{ alert.created_at.strftime('%d/%m %H:%M') }} ·
                      {% if alert.acknowledged %}
                      <span class="badge badge--neutral" aria-label="Alerte confirmée">Accusée</span>
                      {% else %}
                      <span class="badge badge--info" aria-label="Alerte non confirmée">À traiter</span>
                      {% endif %}
                    </p>
                  </div>
                </li>
                {% endfor %}
              </ul>
            </noscript>
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="alerts-history-title">
        <div class="card__header">
          <h2 id="alerts-history-title" class="heading heading--lg">Historique</h2>
          <p class="text text--muted">Déclenchements archivés par le moteur d'alertes.</p>
        </div>
        <div class="card__body">
          <div
            id="alerts-history"
            data-endpoint="{{ alerts_api.history_endpoint }}"
            aria-live="polite"
          ></div>
        </div>
      </section>
    </main>
    <footer class="layout__footer">
      <p class="text text--muted">Données d'exemple pour la démonstration du service.</p>
    </footer>
    <script id="dashboard-bootstrap" type="application/json">
      {{ {"context": context.model_dump(mode='json'), "streaming": streaming}|tojson }}
    </script>
    <script src="/static/dashboard.js" defer></script>
    <script type="module" src="/static/dist/portfolio-chart.js"></script>
  </body>
</html>
