import{P as m,r as l,j as e,e as E,R as _,f as C,i as A}from"./config.DRi9gGxG.js";const R={Accept:"application/json","Content-Type":"application/json"};async function q(t){try{const s=await t.json();if(s&&typeof s.detail=="string")return s.detail;if(s&&s.detail&&s.detail.message)return s.detail.message;if(s&&s.message)return s.message}catch{}return await t.text()||`Erreur ${t.status}`}async function p(t,r={}){const s=await fetch(t,{credentials:"include",...r,headers:{...R,...r.headers||{}}});if(!s.ok){const i=await q(s),n=new Error(i);throw n.status=s.status,n}if(s.status===204)return null;try{return await s.json()}catch{throw new Error("Réponse du serveur invalide")}}async function P(t,r){return p(t,{method:"POST",body:JSON.stringify(r)})}async function T(t){return p(t,{method:"GET"})}async function I(t){return p(t,{method:"POST"})}function y(t){return!t||typeof t!="object"?{authenticated:!1,user:null}:{authenticated:!!t.authenticated,user:t.user&&typeof t.user=="object"?t.user:null}}const j={email:"",password:"",totp:""};function M(t){const[r,s]=l.useState({status:"loading",user:null,error:null}),i=async()=>{s(n=>({...n,status:"loading"}));try{const n=y(await T(t.session));n.authenticated?s({status:"ready",user:n.user,error:null}):s({status:"anonymous",user:null,error:null})}catch(n){s({status:"error",user:null,error:n.message||"Erreur inattendue"})}};return l.useEffect(()=>{i()},[t.session]),[r,i,s]}function b({endpoints:t}){const[r,s,i]=M(t),[n,c]=l.useState(j),[f,u]=l.useState(null),[h,x]=l.useState(!1),d=r.status==="ready"&&!!r.user;r.status==="anonymous"||r.status;const v=l.useMemo(()=>{if(!r.user)return null;const{email:a,id:o}=r.user;return a&&o?`${a} (#${o})`:a||`Utilisateur ${o}`},[r.user]);async function N(a){if(a.preventDefault(),!h){u(null),x(!0);try{const o=await P(t.login,{email:n.email,password:n.password,totp:n.totp?n.totp.trim():void 0}),g=y(o);g.authenticated?(c(j),i({status:"ready",user:g.user,error:null})):await s()}catch(o){u(o.message||"Impossible de se connecter")}finally{x(!1)}}}async function S(){u(null);try{await I(t.logout),i({status:"anonymous",user:null,error:null})}catch(a){u(a.message||"Impossible de se déconnecter")}}const w=()=>r.status==="loading"?e.jsx("div",{className:"alert alert--info",role:"status",children:"Vérification de votre session…"}):r.status==="error"?e.jsx("div",{className:"alert alert--error",role:"alert",children:r.error}):d?e.jsxs("div",{className:"alert alert--success",role:"status",children:["Connecté en tant que ",e.jsx("strong",{children:v})]}):null;return e.jsxs(e.Fragment,{children:[e.jsxs("section",{className:"card","aria-labelledby":"login-title",children:[e.jsxs("div",{className:"card__header",children:[e.jsx("h2",{id:"login-title",className:"heading heading--lg",children:"Connexion"}),e.jsx("p",{className:"text text--muted",children:"Authentifiez-vous pour débloquer les fonctions de sauvegarde et d'orchestration."})]}),e.jsxs("div",{className:"card__body",children:[w(),!d&&e.jsxs("form",{className:"form-grid",onSubmit:N,children:[e.jsxs("label",{className:"designer-field",children:[e.jsx("span",{className:"designer-field__label text text--muted",children:"Adresse e-mail"}),e.jsx("input",{type:"email",name:"email",autoComplete:"email",required:!0,value:n.email,onChange:a=>c(o=>({...o,email:a.target.value}))})]}),e.jsxs("label",{className:"designer-field",children:[e.jsx("span",{className:"designer-field__label text text--muted",children:"Mot de passe"}),e.jsx("input",{type:"password",name:"password",autoComplete:"current-password",required:!0,value:n.password,onChange:a=>c(o=>({...o,password:a.target.value}))})]}),e.jsxs("label",{className:"designer-field",children:[e.jsx("span",{className:"designer-field__label text text--muted",children:"Code TOTP (facultatif)"}),e.jsx("input",{type:"text",name:"totp",inputMode:"numeric",pattern:"[0-9]*",autoComplete:"one-time-code",value:n.totp,onChange:a=>c(o=>({...o,totp:a.target.value}))})]}),f&&e.jsx("p",{className:"text text--danger",role:"alert",children:f}),e.jsx("button",{type:"submit",className:"button button--primary",disabled:h,children:h?"Connexion en cours…":"Se connecter"})]}),d&&e.jsx("div",{className:"account-session__actions",children:e.jsx("button",{type:"button",className:"button button--secondary",onClick:S,children:"Se déconnecter"})})]})]}),e.jsxs("section",{className:"card","aria-labelledby":"api-keys-title",children:[e.jsxs("div",{className:"card__header",children:[e.jsx("h2",{id:"api-keys-title",className:"heading heading--lg",children:"Clés API exchanges"}),e.jsx("p",{className:"text text--muted",children:"Stockez vos identifiants chiffrés. Ils seront synchronisés avec l'orchestrateur lors des déploiements."})]}),e.jsx("div",{className:"card__body",children:d?e.jsx("p",{className:"text",children:"La gestion des clés API sera disponible prochainement. Vos identifiants seront chiffrés avant toute synchronisation."}):e.jsx("p",{className:"text text--muted",children:"Connectez-vous pour accéder à la gestion sécurisée de vos clés API exchanges."})})]})]})}b.propTypes={endpoints:m.shape({session:m.string.isRequired,login:m.string.isRequired,logout:m.string.isRequired}).isRequired};function k(){const t=document.getElementById("account-app");if(!t)return;const{sessionEndpoint:r,loginEndpoint:s,logoutEndpoint:i}=t.dataset;if(!r||!s||!i){console.error("Endpoints manquants pour initialiser la gestion de compte");return}E(t).render(e.jsx(_.StrictMode,{children:e.jsx(C,{i18n:A,children:e.jsx(b,{endpoints:{session:r,login:s,logout:i}})})}))}k();
